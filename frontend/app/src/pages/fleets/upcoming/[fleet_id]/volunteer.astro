---
import { i18n } from '@helpers/i18n'
const { t, translatePath } = i18n(Astro.url)

import { prod_error_messages } from '@helpers/env'
import { HTTP_404_Not_Found, HTTP_403_Forbidden } from '@helpers/http_responses'

import type { User } from '@dtypes/jwt'
import * as jose from 'jose'

const auth_token = Astro.cookies.has('auth_token') ? Astro.cookies.get('auth_token')?.value as string : false
const user: User | false = auth_token ? (jose.decodeJwt(auth_token) as User) : false

if (!user) return Astro.redirect(`${translatePath('/redirects/auth_init')}?redirect_url=${encodeURIComponent(Astro.url.toString())}`)

const fleet_id = parseInt(Astro.params?.fleet_id ?? '')
if (isNaN(fleet_id)) return HTTP_404_Not_Found()

import type { SummaryCharacter } from '@dtypes/api.minmatar.org'
import type { FleetUI } from '@dtypes/layout_components'
import { get_characters_summary_sorted } from '@helpers/fetching/characters'
import { fetch_fleet_by_id } from '@helpers/fetching/fleets'
import {
    get_fleet_role_volunteers,
    type FleetRoleVolunteer,
} from '@helpers/api.minmatar.org/fleets'

let fleet: FleetUI | null = null
let pilots: SummaryCharacter[] = []
let volunteers: FleetRoleVolunteer[] = []
let fetch_error: string | false = false

try {
    fleet = await fetch_fleet_by_id(auth_token as string, fleet_id)
    const history = Boolean(fleet?.tracking?.end_time)

    if (history) return Astro.redirect(translatePath(`/fleets/upcoming/${fleet_id}`))
} catch (e) {
    if (e.message?.includes('403')) return HTTP_403_Forbidden()
    if (e.message?.includes('404')) return HTTP_404_Not_Found()
    fetch_error = prod_error_messages() ? 'Could not load fleet' : (e as Error).message
}

if (fleet) {
    try {
        const summary = await get_characters_summary_sorted(auth_token as string)
        pilots = summary.characters ?? []
        volunteers = await get_fleet_role_volunteers(auth_token as string, fleet_id)
    } catch (e) {
        fetch_error = prod_error_messages() ? t('get_characters_error') : (e as Error).message
    }
}

import { query_string } from '@helpers/string';
const FLEET_ROLES_PARTIAL_URL = translatePath(`/partials/fleet_role_component?${query_string({
    fleet_id: fleet_id,
    readonly: false,
})}`)

import Viewport from '@layouts/Viewport.astro'

import PageDefault from '@components/page/PageDefault.astro'
import PageTitle from '@components/page/PageTitle.astro'

import FlexInline from '@components/compositions/FlexInline.astro'

import Button from '@components/blocks/Button.astro'
import FleetRoles from '@components/blocks/FleetRoles.astro'
import ErrorRefetch from '@components/blocks/ErrorRefetch.astro'

const page_title = t('fleets.volunteer.page_title').replace('{fleet_id}', fleet_id.toString())
---

<Viewport
    title={page_title}
    components={{
        alert_dialog: true,
    }}
>
    <PageDefault
        cover={{
            image: '/images/fleets-cover.jpg',
            image_990: '/images/fleets-cover.jpg',
            animated: false,
            scrollable: true,
            overlay: true,
        }}
    >
        <FlexInline slot="header" justification="space-between" class="[ w-full ]">
            <PageTitle>{page_title}</PageTitle>
            <FlexInline gap="var(--space-s)">
                <Button href={translatePath(`/fleets/upcoming/${fleet_id}`)}>
                    {t('back_to_fleet_details')}
                </Button>
            </FlexInline>
        </FlexInline>

        {fetch_error ?
            <ErrorRefetch
                args={{
                    partial: FLEET_ROLES_PARTIAL_URL,
                    message: fetch_error,
                    delay: 0,
                }}
            />
            :
            <FleetRoles
                volunteers={volunteers}
                pilots={pilots}
                fleet_id={fleet_id}
                readonly={false}
            />
        }
    </PageDefault>
</Viewport>

<style is:global>
    .volunteer-remove-btn {
        font-family: var(--button-font);
        font-weight: 600;
        font-size: var(--step--2);
        padding: var(--space-3xs) var(--space-2xs);
        border: solid 1px var(--fleet-red);
        color: var(--fleet-yellow);
        background-color: var(--fleet-red);
        border-radius: 2px;
        cursor: pointer;
        transition: var(--fast-transition);
    }
    .volunteer-remove-btn:hover { filter: brightness(1.1); }
    .volunteer-remove-btn:focus-visible { outline: none; box-shadow: 0 0 0 2px var(--fleet-yellow); }
</style>
