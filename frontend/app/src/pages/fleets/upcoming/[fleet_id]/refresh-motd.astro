---
import { i18n } from '@helpers/i18n'
const { translatePath } = i18n(Astro.url)

import type { User } from '@dtypes/jwt'
import * as jose from 'jose'

const auth_token = Astro.cookies.has('auth_token') ? Astro.cookies.get('auth_token')?.value as string : false
const user: User | false = auth_token ? (jose.decodeJwt(auth_token) as User) : false

if (!user) {
    return Astro.redirect(`${translatePath('/redirects/auth_init')}?redirect_url=${encodeURIComponent(Astro.url.toString())}`)
}

const fleet_id = parseInt(Astro.params?.fleet_id ?? '')
if (isNaN(fleet_id)) {
    return Astro.redirect(translatePath('/fleets/upcoming/'))
}

import { refresh_fleet_motd } from '@helpers/api.minmatar.org/fleets'

const redirect_url = translatePath(`/fleets/upcoming/${fleet_id}`)

if (Astro.request.method === 'POST') {
    try {
        await refresh_fleet_motd(auth_token, fleet_id)
        return Astro.redirect(`${redirect_url}?motd_refreshed=1`)
    } catch {
        return Astro.redirect(`${redirect_url}?motd_error=1`)
    }
}

return Astro.redirect(redirect_url)
---
