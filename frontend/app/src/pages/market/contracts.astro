---
import { i18n } from '@helpers/i18n'
const { lang, t, translatePath } = i18n(Astro.url)

import type { User } from '@dtypes/jwt'
import * as jose from 'jose'

const auth_token = Astro.cookies.has('auth_token') ? (Astro.cookies.get('auth_token')?.value as string) : false
const user:User | false = auth_token ? jose.decodeJwt(auth_token) as User : false

const user_is_superadmin = (auth_token && user ? user.is_superuser : false)

import { get_user_permissions } from '@helpers/permissions'
const user_permissions = (user ? await get_user_permissions(user?.username) : [])

const is_supplier = user_is_superadmin || user_permissions.includes('market.add_evemarketcontractresponsibility')

import { get_contracts_data } from '@helpers/pages/contracts'
import type { ContractsData } from '@helpers/pages/contracts'
import type { LocationMarketData } from '@helpers/fetching/market'

let contracts_data:ContractsData = {}
let data_fetching_error

try {
    contracts_data = await get_contracts_data(auth_token, lang)
} catch (error) {
    data_fetching_error = error.message
}

import { query_string } from '@helpers/string';

const {
    market_locations = [],
    characters_options = [],
    corporations_options = [],
} = contracts_data

// Calculate total contracts count from market locations
const contracts_count = market_locations.reduce((total, location) => {
    return total + location.doctrines.reduce((doctrineTotal, doctrine) => {
        return doctrineTotal + doctrine.fittings.length
    }, 0)
}, 0)

// Get active location from query param or default to first
let active_location_id: number | null = null
const location_id_param = Astro.url.searchParams.get('location_id')
if (location_id_param) {
    active_location_id = parseInt(location_id_param)
} else if (market_locations.length > 0) {
    active_location_id = market_locations[0].location_id
}


import Viewport from '@layouts/Viewport.astro';

import PageWide from '@components/page/PageWide.astro';
import PageTitle from '@components/page/PageTitle.astro';

import Flexblock from '@components/compositions/Flexblock.astro';
import FlexInline from '@components/compositions/FlexInline.astro';
import Wrapper from '@components/compositions/Wrapper.astro';
import BlockList from '@components/compositions/BlockList.astro';

import ErrorRefetch from '@components/blocks/ErrorRefetch.astro';
import ContractsList from '@components/blocks/ContractsList.astro'
import Input from '@components/blocks/Input.astro'
import StagingsReel from '@components/blocks/StagingsReel.astro';
import StagingReelSlide from '@components/blocks/StagingReelSlide.astro';
import StylessButton from '@components/blocks/StylessButton.astro';
import MarketFittingCard from '@components/blocks/MarketFittingCard.astro';

import MagnifierIcon from '@components/icons/buttons/MagnifierIcon.astro';

const REEL_GAP = 20

const page_title = t('contracts.page_title')
const page_description = t('contracts.leading_text')
---

<Viewport
    title={page_title}
    meta_description={page_description}
    components={{
        alert_dialog: true,
        confirm_dialog: true,
    }}
>
    <PageWide
        cover={{
            image: "/images/contracts-cover.jpg",
            image_990: "/images/contracts-cover.jpg",
            animated: false,
            scrollable: true,
            overlay: true
        }}
        x-data={`{
            contracts_count: ${contracts_count},
            item_name_filter: '',
            countVisibleElements(selector, parent = document) {
                const elements = parent.querySelectorAll(selector)
                let visible_count = 0

                elements.forEach(element => {
                    const is_visible = element.offsetParent !== null
                    if (is_visible)
                        visible_count++
                })

                return visible_count
            },
            show_item(el) {
                const content_to_filter = el.querySelectorAll('.title')
                const show_item = ( this.item_name_filter === '' || content_to_filter[0].textContent.toLowerCase().includes(this.item_name_filter.toLowerCase()) )

                return show_item
            },
        }`}
    >
        <FlexInline slot="header" justification='space-between' class="[ w-full ]">
            <FlexInline>
                <PageTitle>
                    {page_title}
                </PageTitle>
            </FlexInline>
            <Input type="text"
                placeholder={t('filter')}
                x-model="item_name_filter"
                x-on:keyup="setTimeout(function () { contracts_count = countVisibleElements('.title') })"
            >
                <MagnifierIcon slot="icon" />
            </Input>
        </FlexInline>

    
        {data_fetching_error ?
            <ErrorRefetch
                args={{
                    partial: '',
                    message: data_fetching_error,
                    delay: 0,
                }}
            />
            :
            market_locations.length > 0 ?
                <Flexblock role="list" gap='var(--space-xl)'>
                    <StagingsReel gap={REEL_GAP}>
                        {market_locations.map(location => {
                            const fitting_count = location.doctrines.reduce((total, doctrine) => total + doctrine.fittings.length, 0)
                            return (
                                <StagingReelSlide gap={REEL_GAP}>
                                    <Wrapper padding_block='0' padding_inline='0' max_width='350px'>
                                        {active_location_id === location.location_id ?
                                            <Flexblock gap="var(--space-3xs)">
                                                <h2>{location.short_name || location.location_name}</h2>
                                                <small>{fitting_count} {fitting_count !== 1 ? t('fittings') : t('fitting')}</small>
                                            </Flexblock>
                                            :
                                            <StylessButton class="[ w-full staging-selector ]" href={translatePath(`/market/contracts/?${query_string({location_id: location.location_id})}`)}>
                                                <Flexblock gap="var(--space-3xs)">
                                                    <h2>{location.short_name || location.location_name}</h2>
                                                    <small>{fitting_count} {fitting_count !== 1 ? t('fittings') : t('fitting')}</small>
                                                </Flexblock>
                                            </StylessButton>
                                        }
                                    </Wrapper>
                                </StagingReelSlide>
                            )
                        })}
                    </StagingsReel>

                    {market_locations.map((location) =>
                        location.location_id === active_location_id &&
                            <Flexblock gap='var(--space-xl)'>
                                {location.doctrines.length > 0 && (
                                    <Flexblock gap='var(--space-lg)'>
                                        {location.doctrines.map((doctrine) => (
                                            <Flexblock gap='var(--space-md)' class="[ doctrine-section ]">
                                                <Wrapper padding_block='calc(var(--space-lg) + 3px)' padding_inline='calc(var(--space-lg) + 3px)'>
                                                    <BlockList
                                                        gap='var(--space-3xs)'
                                                        class="[ w-full ]"
                                                    >
                                                        {doctrine.fittings.map((fitting) => (
                                                            <div class="[ fitting-card-container ]" x-show="show_item($el)">
                                                                <MarketFittingCard fitting={fitting} />
                                                            </div>
                                                        ))}
                                                    </BlockList>
                                                </Wrapper>
                                            </Flexblock>
                                        ))}
                                    </Flexblock>
                                )}
                            </Flexblock>
                    )}
                </Flexblock>
                :
                <p x-show="contracts_count === 0" class="[ text-center ]">{t('no_results')}</p>
        }
	</PageWide>
</Viewport>

<style lang="scss">
    .staging-selector {
        h2 {
            color: var(--faded);
        }

        small {
            color: var(--fleet-yellow);
        }
    }

    .fitting-card-container {
        min-width: 0;
        width: 100%;
    }

</style>