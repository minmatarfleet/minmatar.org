---
import { i18n } from '@helpers/i18n'
const { t, translatePath } = i18n(Astro.url)

import type { User } from '@dtypes/jwt'
import * as jose from 'jose'

const auth_token = Astro.cookies.has('auth_token') ? Astro.cookies.get('auth_token')?.value : false
const user = auth_token ? jose.decodeJwt(auth_token) as User : false
const is_superuser = (user ? user?.is_superuser : false)
import { get_user_permissions } from '@helpers/permissions'

const user_permissions = (user ? await get_user_permissions(user?.username) : [])

const can_manage_posts = is_superuser || user_permissions.includes('posts.add_evepost')
const post_editor = can_manage_posts ? (user as User).user_id : false

import { prod_error_messages } from '@helpers/env'

import type { PostListUI } from '@dtypes/layout_components'
import { fetch_posts_grouped_by_tags } from '@helpers/fetching/posts'
import { post_states } from '@dtypes/api.minmatar.org'
import type { PostStates } from '@dtypes/api.minmatar.org'

let posts: Record<string, PostListUI[]> = {}
let post_fetching_error:string | false = false
let post_count = 0

const state = Astro.url.searchParams.get('state')
let status:PostStates | null = null
if (state && post_states.includes(state as PostStates))
    status = state as PostStates

try {
    let posts_grouped:{
        posts_by_tag: Record<string, PostListUI[]>;
        post_count: number;
    }
    
    if (status === 'published')
        posts_grouped = await fetch_posts_grouped_by_tags({ status: 'published' })
    else if (post_editor && status === 'trash')
        posts_grouped = await fetch_posts_grouped_by_tags({ user_id: post_editor, status: 'trash' })
    else if (post_editor)
        posts_grouped = await fetch_posts_grouped_by_tags({ user_id: post_editor }, true)
    else
        throw new Error(t('invalid_post_fetching_parameters'))

    posts = posts_grouped.posts_by_tag
    post_count = posts_grouped.post_count
} catch (error) {
    post_fetching_error = prod_error_messages() ? t('fetch_doctrines_error') : error.message
}

const count_text = t(post_count != 1 ? 'propaganda_post_plural' : 'propaganda_post_singular').replace('COUNT', String(post_count))

const PROPAGANDA_POSTS_LIST_PARTIAL_URL = `${translatePath('/partials/propaganda_posts_list_component')}${status ? `state=${status}` : ''}`

const delay = parseInt(Astro.url.searchParams.get('delay') ?? '0')

import ErrorRefetch from '@components/blocks/ErrorRefetch.astro';
import PropagandaReels from '@components/blocks/PropagandaReels.astro';
---

{post_fetching_error ?
    <ErrorRefetch
        args={{
            partial: PROPAGANDA_POSTS_LIST_PARTIAL_URL,
            message: post_fetching_error,
            delay: delay,
        }}
    />
    :
    <PropagandaReels
        posts={posts}
        editor_id={post_editor ? post_editor : undefined}
        is_editing={status !== 'published'}
    />
    <div
        x-data={`{
            init() {
                count_text = '${count_text}'
                $el.remove()
            }
        }`}
        style="display: none"
    />
}