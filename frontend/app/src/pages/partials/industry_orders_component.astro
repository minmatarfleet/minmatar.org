---
import { i18n } from '@helpers/i18n'
const { t, translatePath } = i18n(Astro.url)

import type { BaseIndustryOrder, NestedIndustryOrder } from '@dtypes/api.minmatar.org'
import { fetch_orders_summary_flat, fetch_orders_summary } from '@helpers/fetching/industry'

let materials_required:BaseIndustryOrder[] = []
let fetching_error:string | false = false
let orders:NestedIndustryOrder[] = []

try {
    orders = await fetch_orders_summary()
    materials_required = await fetch_orders_summary_flat()
} catch (error) {
    fetching_error = error.message
}

const INDUSTRY_ORDERS_PARTIAL_URL = translatePath('/partials/industry_orders_component')

const count_text = t(orders.length != 1 ? 'orders_post_plural' : 'orders_post_singular').replace('{count}', String(orders.length))

import IndustrySummary from '@components/blocks/IndustrySummary.astro'
import ErrorRefetch from '@components/blocks/ErrorRefetch.astro'
---

{fetching_error !== false ?
    <ErrorRefetch
        args={{
            partial: INDUSTRY_ORDERS_PARTIAL_URL,
            message: fetching_error,
            delay: 0,
        }}
    />
    :
    <IndustrySummary
        orders={orders}
        materials_required={materials_required} 
    />

    <div
        x-data={`{
            init() {
                count_text = '${count_text}'
                $el.remove()
            }
        }`}
        style="display: none"
    />
}