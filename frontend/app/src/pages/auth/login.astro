---
import { i18n } from '@helpers/i18n'
const { t, translatePath } = i18n(Astro.url)

import type { User } from '@dtypes/jwt'
import * as jose from 'jose'

import { query_string } from '@helpers/string';
import { get_characters } from '@helpers/api.minmatar.org/characters'

if (Astro.request.method !== "GET") Astro.redirect(translatePath('/'))

let token:string | null = null
let user:User | null = null

try {
    const error = Astro.url.searchParams.get('error') as string

    if (error)
        throw new Error(t(error as any) !== undefined ? t(error as any) : t('exchange_token_failed'))

    token = Astro.url.searchParams.get('token') as string

    if (!token)
        throw new Error(t('invalid_token'))
    
    user = jose.decodeJwt(token)
    await get_characters(token)
} catch (error) {
    Astro.cookies.set('auth_error', error.message, { path: '/' })
    return Astro.redirect(translatePath('/'))
}

Astro.cookies.set('auth_token', token, { path: '/' })
Astro.cookies.set('avatar', user?.avatar ?? '', { path: '/' })

const redirect = Astro.cookies.has('redirect_after_auth') ? (Astro.cookies.get('redirect_after_auth')?.value as string) : translatePath('/account/')
Astro.cookies.delete('redirect_after_auth', { path: '/' })

return Astro.redirect(redirect)
---