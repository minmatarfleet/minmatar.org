---
import { i18n } from '@helpers/i18n'
const { translatePath } = i18n(Astro.url)

import * as jose from 'jose'

import { get_characters } from '@helpers/api.minmatar.org/characters'

if (Astro.request.method !== "GET") Astro.redirect(translatePath('/'))

let token = null
let user = null
try {
    token = Astro.url.searchParams.get('token')
    user = jose.decodeJwt(token)
    await get_characters(token)
} catch (error) {
    throw new Error(`Error during token exchange: ${error.message}`)
}

const ONE_DAY_IN_MS = 24*60*60*1000
const in_20_days = new Date(new Date().getTime()+(20*ONE_DAY_IN_MS))
Astro.cookies.set('auth_token', token, { path: '/', expires: in_20_days })
Astro.cookies.set('avatar', user.avatar, { path: '/', expires: in_20_days })

const redirect = Astro.cookies.has('redirect_after_auth') ? Astro.cookies.get('redirect_after_auth').value : translatePath('/account/')
Astro.cookies.delete('redirect_after_auth', { path: '/' })

return Astro.redirect(redirect)
---