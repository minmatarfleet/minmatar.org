---
import { i18n } from '@helpers/i18n'
const { t, translatePath } = i18n(Astro.url)

import type { Audience } from '@dtypes/api.minmatar.org'
import type { ButtonColors, ButtonSizes, SelectOptions } from '@dtypes/layout_components';

import { get_app_url } from '@helpers/env'

interface Props {
    size?:              ButtonSizes;
    color?:             ButtonColors;
    audiences:          Audience[];
    hidden?:            boolean;
}

const {
    size = 'lg',
    color = 'green',
    audiences,
    hidden = false,
} = Astro.props

const no_audience_option = {
    label: t('select_audience'),
    value: ''
} as SelectOptions

let AUDIENCES = {}
const audiences_select_options = [  no_audience_option  ].concat(
    audiences.map( (i):SelectOptions => {
        AUDIENCES[i.id] = i.display_name
        return { label: i.display_name, value: i.id }
    } )
)

const default_audience = audiences_select_options.length !== 2 ? audiences_select_options[0].value : audiences_select_options[1].value

import Flexblock from '@components/compositions/Flexblock.astro';
import FlexInline from '@components/compositions/FlexInline.astro';
import BlockList from '@components/compositions/BlockList.astro';
import FixedFluid from '@components/compositions/FixedFluid.astro';

import Dialog from '@components/blocks/Dialog.astro';
import Textarea from '@components/blocks/Textarea.astro';
import Button from '@components/blocks/Button.astro';
import SwitchSquare from '@components/blocks/SwitchSquare.astro';
import Select from '@components/blocks/Select.astro';
import Markdown from '@components/blocks/Markdown.astro';
import StylessButton from '@components/blocks/StylessButton.astro';
import ClipboardButton from '@components/blocks/ClipboardButton.astro';
import CollapsibleBlock from '@components/blocks/CollapsibleBlock.astro';
import VerticalCenter from '@components/blocks/VerticalCenter.astro';

import FlashIcon from '@components/icons/buttons/FlashIcon.astro';
import TutorialIcon from '@components/icons/TutorialIcon.astro';
---

<div
    class="[ flash-form-dialog ]"
    x-data={`{
        flash_form_dialog_open: false,
        description: '',
        audience: '${default_audience}',
        open_dialog() {
            this.description = ''
            this.audience = '${default_audience}'

            $nextTick(() => {
                this.flash_form_dialog_open = true
            })
        },
        close_dialog() {
            this.flash_form_dialog_open = false
        }
    }`}
>
    <Button
        size={size}
        type="button"
        color={color}
        x-on:click.stop.prevent="open_dialog()"
        type="button"
        id="flash-form-button"
        class={hidden ? '[ !hidden ]' : undefined}
    >
        <FlashIcon slot="icon" />
        {t('flash_form')}
    </Button>

    <Dialog
        breakout={true}
        non_centered={true}
        class="[ flash-form-dialog ][ w-full max-w-[450px] component overflow-y-auto ]"
        x-bind:class="(flash_form_dialog_open ? 'open' : '')"
        x-bind:aria-hidden="flash_form_dialog_open == false"
        x-trap="flash_form_dialog_open"
        x-bind:inert="!flash_form_dialog_open"
        @keyup.escape.window="close_dialog()"
        @mousedown.outside="open && close_dialog()"
    >
        <form
            method="POST"
            action={translatePath('/fleets/add/')}
            x-on:submit="close_dialog()"
        >
            <Flexblock gap="var(--space-l)">
                <h3>{t('flash_form')}</h3>

                <Flexblock>
                    <Markdown markdown={t('flash_form_dialog_text')} inline={true} />

                    <BlockList class="[ w-full ]">
                        <Flexblock class="[ w-full ]" gap="var(--space-3xs)">
                            <label>{t('select_audience')}</label>
                            <FlexInline class="[ audiences ]">
                                {audiences.map((option) =>
                                    <StylessButton
                                        x-on:click={`audience = ${option.id}`}
                                        type="button"
                                        data-tippy-content={option.display_name}
                                    >
                                        <img
                                            class:list={{ selected: option.id === default_audience}}
                                            x-bind:class={`{ 'selected': audience === ${option.id} }`}
                                            src={option.image_url ?? '/images/fleet-logo.svg'}
                                            height="96"
                                            width="96"
                                            alt={option.display_name}
                                        />
                                    </StylessButton>
                                )}
                                <div class="[ visually-hidden ]">
                                    <Select
                                        class="[ pointer-events-none ]"
                                        id="audience"
                                        name="audience_id"
                                        x-model="audience"
                                        tabindex="-1"
                                        required
                                    >
                                        {audiences_select_options.map((option) => 
                                            <option value={option.value}>
                                                {option.label}
                                            </option>
                                        )}
                                    </Select>
                                </div>
                            </FlexInline>
                        </Flexblock>
                        <Flexblock class="[ w-full ]" gap="var(--space-3xs)">
                            <label for="description">{t('description')}</label>
                            <Textarea id="description" name="description" x-model="description" rows="4" required></Textarea>
                        </Flexblock>
                        <SwitchSquare
                            class="[ w-full ]"
                            name="disable_motd"
                            label={t('disable_motd')}
                            description={t('disable_motd_description')}
                        />
                        <input type="hidden" name="doctrine_id" value="-1" />
                        <input type="hidden" name="fleet_type" value="non_strategic" />
                        <input type="hidden" name="flash_form" value="1" />
                        <input type="hidden" name="start_tracking" value="on" />
                    </BlockList>
                </Flexblock>

                <CollapsibleBlock>
                    <FixedFluid
                        width='48'
                        breakpoint='70%'
                        slot="head"
                        class="[ w-full items-center ]"
                    >
                        <picture class="[ hidden sm:block ]">
                            <TutorialIcon />
                        </picture>
                        <Flexblock gap='var(--space-3xs)'>
                            <h4>{t('flash_form_express')}</h4>
                            <small>{t('flash_form_hint')}</small>
                        </Flexblock>
                    </FixedFluid>

                    <Flexblock class="[ mt-5 ]">
                        {audiences.map((option) =>
                            <FlexInline gap="var(--space-s)" class="[ w-full !items-center ]">
                                <p class="basis-[250px]"><a href={translatePath(`/fleets/flash_form?audience=${option.id}`)}>{option.display_name}</a></p>
                                <ClipboardButton id={`copy-form-express-${option.id}`} class="[ hidden md:flex relative ]">{translatePath(`/fleets/flash_form?audience=${option.id}`)}</ClipboardButton>
                            </FlexInline>
                        )}
                    </Flexblock>
                </CollapsibleBlock>

                <FlexInline justification='flex-end'>
                    <Button
                        size='sm'
                        type="submit"
                        color='green'
                    >
                        {t('start_formation')}
                    </Button>
                    <Button
                        type="button"
                        size='sm'
                        x-on:click="close_dialog()"
                    >
                        {t('close')}
                    </Button>
                </FlexInline>
            </Flexblock>
        </form>
    </Dialog>
</div>

<style lang="scss">
    .flash-form-dialog {
        max-width: 40rem;
        max-height: min(750px, 88vh);
    }
</style>

<style lang="scss">
    .audiences{
        button:focus-visible {
            outline: none;
            img {
                transform: scale(0.8);
                filter: saturate(0.5);
            }
        }

        img {
            filter: saturate(0);
            transform: scale(0.6);
            transition: var(--fast-transition);

            &:hover {
                transform: scale(0.8);
                filter: saturate(0.5);
            }

            &.selected {
                filter: saturate(1) !important;
                transform: scale(1) !important;
            }
        }
    }
</style>