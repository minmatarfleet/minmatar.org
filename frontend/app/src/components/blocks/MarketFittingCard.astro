---
import { i18n } from '@helpers/i18n'
const { t } = i18n(Astro.url)

import type { FittingMarketData } from '@helpers/fetching/market'

interface Props {
    fitting: FittingMarketData;
    [propName: string]: any;
}

const {
    fitting,
    ...attributes
} = Astro.props

const expected_quantity = fitting.expectation_quantity ?? 0
const current_quantity = fitting.current_quantity ?? 0
const low_amount = expected_quantity > 0 && (current_quantity <= (20 * expected_quantity) / 100)

import FlexInline from "@components/compositions/FlexInline.astro";
import FixedFluid from "@components/compositions/FixedFluid.astro";

import ComponentBlock from '@components/blocks/ComponentBlock.astro';
import { get_item_icon } from '@helpers/eve_image_server';
---
<ComponentBlock padding_block='var(--space-2xs)' padding_inline='var(--space-2xs)' class="[ market-fitting-card ]" {...attributes}>
    <FlexInline justification='space-between' class="[ !flex-nowrap ]">
        <FixedFluid width='32px' class="[ items-center basis-[350px] ]">
            <picture>
                <img loading="lazy" src={get_item_icon(fitting.ship_id, 32)} width={32} height={32} />
            </picture>
            <h3 
                x-on:click.stop.prevent={`copyFitToClipboard('fitting-name-${fitting.fitting_id}')`}
                class="[ cursor-pointer title ]"
                x-data={`{
                    original_text: '${fitting.fitting_name}',
                }`}
                x-on:click.throttle.750ms={`$el.textContent = '${t('copied')}'; setTimeout(() => $el.textContent = original_text, 2000)`}
            >
                {fitting.fitting_name}
            </h3>
        </FixedFluid>

        <FlexInline class="[ quantity basis-[150px] ]">
            <span><b class:list={{ 'text-red': low_amount }}>{current_quantity}</b>/{expected_quantity}</span>
        </FlexInline>

        <slot name="actions" />
    </FlexInline>
</ComponentBlock>
<textarea class="[ hidden ]" id={`fitting-name-${fitting.fitting_id}`} readonly>{fitting.fitting_name}</textarea>

<style lang="scss">
    .market-fitting-card {
        width: 100%;
    }

    .quantity {
        font-family: var(--heading-font);
        text-transform: uppercase;
        font-size: var(--step-0);
        font-weight: 400;
        color: var(--highlight);
    }

    .title {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        min-width: 0;
        flex: 1;
    }

    h3 {
        font-size: var(--step--1);
        line-height: 1.2;
    }
</style>
