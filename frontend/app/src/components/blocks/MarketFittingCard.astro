---
import { i18n } from '@helpers/i18n'
const { t } = i18n(Astro.url)

import type { FittingMarketData } from '@helpers/fetching/market'

interface Props {
    fitting: FittingMarketData;
    [propName: string]: any;
}

const {
    fitting,
    ...attributes
} = Astro.props

const expected_quantity = fitting.expectation_quantity ?? 0
const current_quantity = fitting.current_quantity ?? 0
const low_amount = expected_quantity > 0 && (current_quantity <= (20 * expected_quantity) / 100)

import Flexblock from "@components/compositions/Flexblock.astro";
import FlexInline from "@components/compositions/FlexInline.astro";
import Wrapper from "@components/compositions/Wrapper.astro";

import ComponentBlock from '@components/blocks/ComponentBlock.astro';
import ItemPicture from "@components/blocks/ItemPicture.astro";
---

<ComponentBlock class="[ fitting-card card-animated ]" padding_block='var(--space-xs)' padding_inline='var(--space-xs)' {...attributes}>
    <Flexblock gap="0" class="[ fitting-card-container ]">
        <div class="[ fitting-card-image-wrapper ]">
            <ItemPicture
                item_id={fitting.ship_id}
                item_name={fitting.ship_name}
                size={256}
                narrow={true}
                icon_quality={512}
                mask={true}
            />
        </div>
        <Wrapper class="[ fitting-card-bar ]" padding_block="var(--space-2xs)" padding_inline="var(--space-2xs)">
            <FlexInline justification='space-between' class="[ items-center ]">
                <h3 
                    x-on:click.stop.prevent={`copyFitToClipboard('fitting-name-${fitting.fitting_id}')`}
                    class="[ cursor-pointer title fitting-name ]"
                    x-data={`{
                        original_text: '${fitting.fitting_name}',
                    }`}
                    x-on:click.throttle.750ms={`$el.textContent = '${t('copied')}'; setTimeout(() => $el.textContent = original_text, 2000)`}
                >
                    {fitting.fitting_name}
                </h3>
                <div class="[ expectation-badge ]">
                    <span class:list={{ 'text-red': low_amount }}>{current_quantity}</span>/{expected_quantity}
                </div>
            </FlexInline>
        </Wrapper>
        <textarea class="[ hidden ]" id={`fitting-name-${fitting.fitting_id}`} readonly>{fitting.fitting_name}</textarea>
    </Flexblock>
</ComponentBlock>

<style lang="scss">
    .fitting-card {
        position: relative;
        overflow: hidden;
        width: 100%;
        border: solid 0.5px var(--border-color);

        .fitting-card-container {
            display: flex;
            flex-direction: column;
        }

        .fitting-card-image-wrapper {
            flex: 1;
            min-height: 180px;
            overflow: hidden;
            position: relative;

            &::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.4);
                pointer-events: none;
                z-index: 1;
            }

            :global(picture),
            :global(img) {
                height: 100%;
                width: 100%;
                object-fit: cover;
            }
        }

        .fitting-card-bar {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        .fitting-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 0;
            flex: 1;
            margin-right: var(--space-xs);
        }

        .expectation-badge {
            font-family: var(--heading-font);
            text-transform: uppercase;
            font-size: var(--step--1);
            font-weight: 400;
            color: var(--highlight);
            white-space: nowrap;
            flex-shrink: 0;
        }
    }

    h3 {
        font-size: var(--step--1);
        line-height: 1.2;
    }

    small {
        color: var(--fleet-yellow);
        font-size: var(--step--1);
    }
</style>

